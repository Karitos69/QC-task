<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager â€“ RTL + Firestore + Modal Edit</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--text:#111;--muted:#6b7280;--border:#e5e7eb;--accent:#111}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .section{padding:18px}
    .title{margin:0 0 8px;font-weight:700}
    .subtitle{margin:0 0 16px;color:var(--muted);font-size:.95rem}
    .row{display:flex;align-items:center;gap:8px}
    .space-between{justify-content:space-between}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#f3f4f6}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:.8rem;background:#fafafa}
    .list{display:flex;flex-direction:column;gap:10px}
    .task{border:1px solid var(--border);border-radius:14px;padding:10px}
    .task .muted{color:var(--muted);font-size:.9rem}
    .task .line-through{text-decoration:line-through;color:#9ca3af}
    .select, input[type="text"], input[type="datetime-local"], input[type="date"]{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px}
    .calendar{padding:14px}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:6px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-day{aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .cal-day.out{opacity:.35}
    .cal-day.today{border-color:#111}
    .cal-day.selected{background:#111;color:#fff;border-color:#111}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none}
    .modal{position:fixed;inset-inline:0;top:8vh;margin-inline:auto;width:min(640px,92vw);background:#fff;border-radius:18px;border:1px solid var(--border);padding:16px 16px 14px;display:none}
    .backdrop.show,.modal.show{display:block}
    .subtasks{display:flex;flex-direction:column;gap:8px}
    .subtask-row{display:flex;gap:8px}
    .subtask-row input{flex:1}
    .footer{margin-top:22px;text-align:center;color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="grid">
      <!-- Calendar column -->
      <div>
        <div class="card calendar">
          <div class="cal-head">
            <div class="row" id="monthLabel" style="font-weight:600"></div>
            <div class="row">
              <button class="btn" id="prevMonth" aria-label="Previous month">â—€</button>
              <button class="btn" id="nextMonth" aria-label="Next month">â–¶</button>
            </div>
          </div>
          <div class="cal-weekdays" aria-hidden="true">
            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
          </div>
          <div id="calGrid" class="cal-grid" role="grid" aria-label="Calendar"></div>
        </div>

        <div class="card section" style="margin-top:12px">
          <div class="row space-between">
            <h3 class="title" id="selDateTitle"></h3>
            <button id="addTaskBtn" class="btn primary">ï¼‹ Add Task</button>
          </div>
          <div id="selectedList" class="list"></div>
        </div>
      </div>

      <!-- Today column -->
      <div class="grid" style="grid-template-columns:1fr">
        <div class="card section">
          <div class="row space-between">
            <h2 class="title">Today â€” <span id="todayLabel"></span></h2>
            <button class="btn primary" id="exportPdfBtn">ðŸ“„ Export PDF</button>
          </div>
          <p class="subtitle">Tasks to complete (auto-carry forward until done)</p>
          <div id="todayList" class="list"></div>
        </div>
      </div>
    </div>

    <div class="footer">RTL layout â€¢ English UI â€¢ Firestore + local fallback â€¢ Auto carry-forward â€¢ PDF Export â€¢ Edit in modal</div>
  </div>

  <!-- Add/Edit Task Modal (restored, English labels, RTL layout) -->
  <div id="backdrop" class="backdrop"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="row space-between">
      <h3 id="modalTitle" class="title" style="margin:0">Add Task</h3>
      <button class="btn" id="closeModal">Close</button>
    </div>
    <div style="margin-top:10px">
      <label for="taskTitle">Task title</label>
      <input type="text" id="taskTitle" placeholder="What needs to be done?" />
    </div>
    <div style="margin-top:10px">
      <label for="taskReminder">Reminder (optional)</label>
      <input type="datetime-local" id="taskReminder" />
      <div class="subtitle" style="margin:6px 0 0">Reminders are informational only</div>
    </div>
    <div style="margin-top:10px">
      <div class="row space-between">
        <label>Subtasks (optional)</label>
        <button class="btn" id="addSubtask">Add subtask</button>
      </div>
      <div id="subtasks" class="subtasks"></div>
    </div>
    <div class="row" style="justify-content:end;margin-top:14px;gap:8px">
      <button class="btn" id="cancelModal">Cancel</button>
      <button class="btn primary" id="saveTask">Save</button>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <script>
    // ===== App (UI + local fallback) =====
    const { jsPDF } = window.jspdf;
    const STATUS = { TODO:'todo', IN_PROGRESS:'in_progress', DEFERRED:'deferred', DONE:'done' };
    const STATUS_LABEL = { todo:'New', in_progress:'In Progress', deferred:'Deferred', done:'Done' };
    const LS_TASKS = 'task_manager_tasks_html_fs_rtl_v1';

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toISODate = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fromISO = (s) => { const [y,m,d] = s.split('-').map(Number); return new Date(y,m-1,d); };
    const isSameDay = (a,b) => a.toDateString()===b.toDateString();
    const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate()+n); return r; };
    const fmtDate = (d, opts) => new Intl.DateTimeFormat('en-GB', opts || { day:'2-digit', month:'short', year:'numeric' }).format(d);

    function loadTasks(){ try{ return JSON.parse(localStorage.getItem(LS_TASKS))||[]; }catch{return [];} }
    function saveTasks(){ localStorage.setItem(LS_TASKS, JSON.stringify(tasks)); }

    function normalizeToISODate(v){
      try{
        if(!v) return null;
        if(typeof v==='string') return v.slice(0,10);
        if(v instanceof Date) return toISODate(v);
        if(v && typeof v.toDate==='function') return toISODate(v.toDate()); // Firestore Timestamp
        return null;
      }catch{return null;}
    }

    // State
    let tasks = []; // local cache (also mirrors cloud)
    let selectedDate = new Date();
    let currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
    let editingId = null; // null = add, otherwise edit

    // Auto-carry forward (local cache)
    function migrateForwardLocal(){
      const today = new Date(); today.setHours(0,0,0,0);
      let changed=false;
      for(const t of tasks){
        if((t.status||'').toLowerCase()==='done') continue;
        const iso = normalizeToISODate(t.date); if(!iso) continue;
        let d = fromISO(iso); d.setHours(0,0,0,0);
        while(d < today){ d = addDays(d,1); }
        const newISO = toISODate(d);
        if(newISO!==iso){ t.date=newISO; changed=true; }
      }
      if(changed) saveTasks();
    }

    // Calendar helpers
    function startOfWeek(d){ const r=new Date(d); const day=r.getDay(); r.setDate(r.getDate()-day); r.setHours(0,0,0,0); return r; }
    function endOfWeek(d){ const r=startOfWeek(d); r.setDate(r.getDate()+6); return r; }
    function fmtMonthLabel(d){ return new Intl.DateTimeFormat('en-GB',{month:'long',year:'numeric'}).format(d); }
    function fmtDay(d){ return new Intl.DateTimeFormat('en-GB',{day:'numeric'}).format(d); }

    function renderCalendar(){
      document.getElementById('monthLabel').textContent = fmtMonthLabel(currentMonth);
      const grid=document.getElementById('calGrid'); grid.innerHTML='';
      const start = startOfWeek(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1));
      const endMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0);
      const end = endOfWeek(endMonth);
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const day=new Date(d);
        const btn=document.createElement('button');
        btn.type='button'; btn.className='cal-day'; btn.textContent=fmtDay(day);
        if(day.getMonth()!==currentMonth.getMonth()) btn.classList.add('out');
        if(isSameDay(day,new Date())) btn.classList.add('today');
        if(isSameDay(day,selectedDate)) btn.classList.add('selected');
        btn.addEventListener('click',()=>{ selectedDate=new Date(day); renderCalendar(); renderSelected(); if(window.cloudOnSelectDate) window.cloudOnSelectDate(toISODate(selectedDate)); });
        grid.appendChild(btn);
      }
    }

    // Rendering
    function tasksFor(dateISO){ return tasks.filter(t=> normalizeToISODate(t.date)===dateISO); }

    function renderSubtasks(t){
      if(!t.subtasks||!t.subtasks.length) return null;
      const wrap=document.createElement('div'); wrap.style.marginTop='8px';
      t.subtasks.forEach(st=>{
        const lab=document.createElement('label'); lab.className='row'; lab.style.gap='8px';
        const c=document.createElement('input'); c.type='checkbox'; c.checked=!!st.done;
        c.onchange=async()=>{
          const newSubs=t.subtasks.map(s=> s.id===st.id?{...s,done:c.checked}:s);
          if(window.cloudUpdateTask){ try{ await window.cloudUpdateTask(t.id,{subtasks:newSubs}); }catch(e){ console.warn(e);} }
          st.done=c.checked; saveTasks();
        };
        const sp=document.createElement('span'); sp.textContent=st.text||''; if(st.done) sp.classList.add('line-through','muted');
        lab.append(c,sp); wrap.appendChild(lab);
      });
      return wrap;
    }

    function taskRow(t){
      const wrap=document.createElement('div'); wrap.className='task';
      const top=document.createElement('div'); top.className='row space-between';
      const left=document.createElement('div'); left.className='row';

      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=(t.status||'')==='done';
      cb.onchange=async()=>{
        const newStatus=cb.checked?'done':'todo';
        if(window.cloudUpdateTask){ try{ await window.cloudUpdateTask(t.id,{status:newStatus}); }catch(e){ console.warn(e);} }
        t.status=newStatus; saveTasks(); renderAll();
      };
      const ttl=document.createElement('div'); ttl.textContent=t.title||'(No title)'; ttl.style.fontWeight='600'; if((t.status||'')==='done') ttl.classList.add('line-through');
      left.append(cb,ttl);

      const right=document.createElement('div'); right.className='row';
      const editBtn=document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Edit';
      editBtn.onclick=()=> openModal('edit', t);
      const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Delete';
      delBtn.onclick=async()=>{ if(window.cloudDeleteTask){ try{ await window.cloudDeleteTask(t.id);}catch(e){console.warn(e);} } tasks=tasks.filter(x=>x.id!==t.id); saveTasks(); renderAll(); };
      right.append(editBtn,delBtn);

      top.append(left,right); wrap.append(top);

      const st=renderSubtasks(t); if(st) wrap.appendChild(st);
      return wrap;
    }

    function renderSelected(){
      const selISO=toISODate(selectedDate);
      document.getElementById('selDateTitle').textContent = `Tasks for ${fmtDate(selectedDate)}`;
      const list=document.getElementById('selectedList'); list.innerHTML='';
      const items=tasksFor(selISO); if(items.length===0){ list.innerHTML='<div class="subtitle">No tasks</div>'; return; }
      items.forEach(t=> list.appendChild(taskRow(t)));
    }

    function renderToday(){
      document.getElementById('todayLabel').textContent = fmtDate(new Date());
      const list=document.getElementById('todayList'); list.innerHTML='';
      const items=tasksFor(toISODate(new Date())); if(items.length===0){ list.innerHTML='<div class="subtitle">No tasks for today</div>'; return; }
      items.forEach(t=> list.appendChild(taskRow(t)));
    }

    function renderAll(){ renderCalendar(); renderSelected(); renderToday(); }

    // ===== Modal logic (Add/Edit) =====
    const backdrop=document.getElementById('backdrop');
    const modal=document.getElementById('modal');
    const openModal=(mode='add', task=null)=>{
      editingId = (mode==='edit' && task)? task.id : null;
      document.getElementById('modalTitle').textContent = (editingId? 'Edit Task' : 'Add Task');
      document.getElementById('taskTitle').value = task? (task.title||'') : '';
      document.getElementById('taskReminder').value = task && task.reminder? String(task.reminder).slice(0,16) : '';
      const stWrap=document.getElementById('subtasks'); stWrap.innerHTML='';
      const subs = task && Array.isArray(task.subtasks)? task.subtasks : [];
      subs.forEach(st=>{ const row=addSubtaskRow(st.text||''); const chk=row.querySelector('input[type="checkbox"]'); if(chk) chk.checked=!!st.done; });
      backdrop.classList.add('show'); modal.classList.add('show');
    };
    const closeModal=()=>{ backdrop.classList.remove('show'); modal.classList.remove('show'); resetModal(); };
    const resetModal=()=>{ document.getElementById('taskTitle').value=''; document.getElementById('taskReminder').value=''; document.getElementById('subtasks').innerHTML=''; editingId=null; };

    document.getElementById('closeModal').onclick=closeModal;
    document.getElementById('cancelModal').onclick=closeModal;
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });

    function addSubtaskRow(text=''){
      const row=document.createElement('div'); row.className='subtask-row';
      const done=document.createElement('input'); done.type='checkbox';
      const input=document.createElement('input'); input.type='text'; input.placeholder='Subtask'; input.value=text;
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Remove'; btn.onclick=()=> row.remove();
      row.append(done,input,btn); document.getElementById('subtasks').appendChild(row); return row;
    }
    document.getElementById('addSubtask').onclick=()=> addSubtaskRow('');

    document.getElementById('addTaskBtn').onclick=()=> openModal('add');

    document.getElementById('saveTask').onclick=async()=>{
      const title=document.getElementById('taskTitle').value.trim();
      const reminder=document.getElementById('taskReminder').value || null;
      const stEls=[...document.querySelectorAll('#subtasks .subtask-row')];
      if(!title){ alert('Please enter a task title'); return; }
      const subtasks = stEls.map(row=>({ id: uid(), text: row.querySelector('input[type="text"]').value.trim(), done: row.querySelector('input[type="checkbox"]').checked })).filter(s=> s.text!=='' );

      if(editingId){
        // update existing
        const idx = tasks.findIndex(t=> t.id===editingId);
        if(idx>-1){
          const patch = { title, reminder, subtasks };
          if(window.cloudUpdateTask){ try{ await window.cloudUpdateTask(editingId, patch); }catch(e){ console.warn(e);} }
          tasks[idx] = { ...tasks[idx], ...patch };
        }
      } else {
        // add new for selected date
        const newTask = { id: uid(), title, date: toISODate(selectedDate), status: 'todo', reminder, subtasks };
        if(window.cloudAddTask){ try{ await window.cloudAddTask(newTask);} catch(e){ console.warn(e); tasks.push(newTask);} }
        else { tasks.push(newTask); }
      }
      saveTasks(); closeModal(); renderAll();
    };

    // Month navigation
    document.getElementById('prevMonth').onclick=()=>{ currentMonth=new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendar(); };
    document.getElementById('nextMonth').onclick=()=>{ currentMonth=new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendar(); };

    // PDF export
    document.getElementById('exportPdfBtn').onclick=async()=>{
      const from=prompt('From (YYYY-MM-DD)');
      const to=prompt('To (YYYY-MM-DD)');
      if(!from||!to) return; if(from>to){ alert('Invalid range'); return; }
      let items=[];
      if(window.cloudFetchRange){ try{ items=await window.cloudFetchRange(from,to);} catch(e){ console.warn(e); items=tasks; } }
      else { items=tasks; }
      items = items.map(t=>({ ...t, date: normalizeToISODate(t.date)})).filter(t=> t.date && t.date>=from && t.date<=to);

      const doc=new jsPDF({ unit:'pt', format:'a4' }); const marginX=40; let y=48;
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text(`Tasks Report ${from} â€“ ${to}`, marginX, y); y+=20;
      const done=items.filter(t=> (t.status||'').toLowerCase()==='done');
      const notDone=items.filter(t=> (t.status||'').toLowerCase()!=='done');
      const section=(hdr,arr)=>{ y+=10; doc.setFont('helvetica','bold'); doc.text(hdr, marginX, y); y+=12; doc.setFont('helvetica','normal'); doc.setFontSize(12);
        if(arr.length===0){ doc.text('â€” None â€”', marginX, y); y+=16; return; }
        for(const t of arr){ const line=`â€¢ ${t.title||'(No title)'} â€” Date: ${t.date||'â€”'} â€” Status: ${(t.status||'').toString()}`; const parts=doc.splitTextToSize(line, 515); if(y+parts.length*14>800){ doc.addPage(); y=48; } doc.text(parts, marginX, y); y+=parts.length*14+6; }
      };
      section('Section 1: Completed within range', done);
      section('Section 2: Not completed within range', notDone);
      doc.save(`tasks_report_${from}_to_${to}.pdf`);
    };

    // Init (local; cloud will hook and override lists)
    function renderAllAndMaybeCloud(){ renderAll(); if(window.cloudOnSelectDate) window.cloudOnSelectDate(toISODate(selectedDate)); }
    function init(){ tasks=loadTasks(); migrateForwardLocal(); renderAllAndMaybeCloud(); }
    init();
  </script>

  <!-- ===== Firebase / Firestore (module) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLVGDemdsjcCUjeGQwUA06NdDu5QGr9QI",
      authDomain: "qc-task.firebaseapp.com",
      projectId: "qc-task",
      storageBucket: "qc-task.firebasestorage.app",
      messagingSenderId: "811038001243",
      appId: "1:811038001243:web:17093b369a0b12389ad77e",
      measurementId: "G-V7WG3M18B1"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    function ensureAuth(){ return new Promise((resolve,reject)=>{ onAuthStateChanged(auth, async (user)=>{ try{ if(user) return resolve(user); await signInAnonymously(auth); }catch(e){ reject(e); } }); }); }

    // Cloud API
    window.cloudAddTask = async (task)=>{ const id=task.id || (crypto.randomUUID? crypto.randomUUID(): String(Date.now())); await setDoc(doc(tasksCol,id),{...task,id}); return id; };
    window.cloudUpdateTask = async (id, patch)=> updateDoc(doc(tasksCol, id), patch);
    window.cloudDeleteTask = async (id)=> deleteDoc(doc(tasksCol, id));

    window.cloudFetchRange = async (fromISO,toISO)=>{ const q1=query(tasksCol, where('date','>=',fromISO), where('date','<=',toISO)); const snap=await getDocs(q1); const arr=[]; snap.forEach(d=>arr.push(d.data())); arr.sort((a,b)=> (a.date||'').localeCompare(b.date||'')); return arr; };

    window.cloudOnSelectDate = (dateISO)=>{
      if(window._unsubSel) window._unsubSel();
      const qSel=query(tasksCol, where('date','==',dateISO));
      window._unsubSel = onSnapshot(qSel, (snap)=>{
        const items=snap.docs.map(d=>d.data());
        // replace that date in local cache
        const norm=(v)=> (typeof v==='string')? v.slice(0,10) : (v && typeof v.toDate==='function')? `${v.toDate().toISOString().slice(0,10)}` : null;
        tasks = tasks.filter(t=> norm(t.date)!==dateISO).concat(items);
        localStorage.setItem('task_manager_tasks_html_fs_rtl_v1', JSON.stringify(tasks));
        // re-render only the affected lists
        const todayISO=new Date().toISOString().slice(0,10);
        if(dateISO===todayISO) {
          // also listen to today to keep it fresh
          renderToday();
        }
        renderSelected();
      });
    };

    async function migrateForwardCloud(){
      const todayISO=new Date().toISOString().slice(0,10);
      const snap=await getDocs(tasksCol);
      const ups=[];
      snap.forEach(dr=>{ const t=dr.data(); const st=(t.status||'').toLowerCase(); if(st==='done') return; const iso= (typeof t.date==='string')? t.date.slice(0,10) : (t.date && typeof t.date.toDate==='function')? t.date.toDate().toISOString().slice(0,10) : null; if(!iso) return; if(iso<todayISO) ups.push(updateDoc(doc(tasksCol,t.id),{date:todayISO})); });
      if(ups.length) await Promise.all(ups);
    }

    // Live today listener as well
    function subscribeToday(){
      const todayISO=new Date().toISOString().slice(0,10);
      if(window._unsubToday) window._unsubToday();
      const qT=query(tasksCol, where('date','==',todayISO));
      window._unsubToday = onSnapshot(qT,(snap)=>{
        const items=snap.docs.map(d=>d.data());
        const norm=(v)=> (typeof v==='string')? v.slice(0,10) : (v && typeof v.toDate==='function')? `${v.toDate().toISOString().slice(0,10)}` : null;
        tasks = tasks.filter(t=> norm(t.date)!==todayISO).concat(items);
        localStorage.setItem('task_manager_tasks_html_fs_rtl_v1', JSON.stringify(tasks));
        renderToday();
      });
    }

    (async()=>{
      try{
        await ensureAuth();
        await migrateForwardCloud();
        subscribeToday();
        window.cloudOnSelectDate(new Date().toISOString().slice(0,10));
      }catch(e){ console.warn('Cloud not available; running local-only:', e); }
    })();
  </script>
</body>
</html>
