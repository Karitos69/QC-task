<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager â€“ HTML (Calendar Fixed)</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--text:#111;--muted:#6b7280;--border:#e5e7eb;--accent:#111}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .section{padding:18px}
    .title{margin:0 0 8px;font-weight:700}
    .subtitle{margin:0 0 16px;color:var(--muted);font-size:.95rem}
    .row{display:flex;align-items:center;gap:8px}
    .space-between{justify-content:space-between}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#f3f4f6}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .list{display:flex;flex-direction:column;gap:10px}
    .task{border:1px solid var(--border);border-radius:14px;padding:10px}
    .task .muted{color:var(--muted);font-size:.9rem}
    .task .line-through{text-decoration:line-through;color:#9ca3af}
    .calendar{padding:14px}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-day{aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .cal-day.out{opacity:.35}
    .cal-day.today{border-color:#111}
    .cal-day.selected{background:#111;color:#fff;border-color:#111}
    .cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:6px}
    .footer{margin-top:22px;text-align:center;color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="grid">
      <!-- Calendar column -->
      <div>
        <div class="card calendar">
          <div class="cal-head">
            <div class="row" id="monthLabel" style="font-weight:600"></div>
            <div class="row">
              <button class="btn" id="prevMonth" aria-label="Previous month">â—€</button>
              <button class="btn" id="nextMonth" aria-label="Next month">â–¶</button>
            </div>
          </div>
          <div class="cal-weekdays" aria-hidden="true">
            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
          </div>
          <div id="calGrid" class="cal-grid" role="grid" aria-label="Calendar"></div>
        </div>

        <div class="card section" style="margin-top:12px">
          <div class="row space-between">
            <h3 class="title" id="selDateTitle"></h3>
            <button id="addTaskBtn" class="btn primary">ï¼‹ Add Task</button>
          </div>
          <div id="selectedList" class="list"></div>
        </div>
      </div>

      <!-- Main column -->
      <div class="grid" style="grid-template-columns:1fr">
        <div class="card section">
          <h2 class="title">Today â€“ <span id="todayLabel"></span></h2>
          <p class="subtitle">Tasks to complete</p>
          <div id="todayList" class="list"></div>
          <button class="btn primary" id="exportPdfBtn" style="margin-top:10px">ðŸ“„ Export PDF</button>
        </div>
      </div>
    </div>

    <div class="footer">HTML Task Manager â€¢ LocalStorage â€¢ Auto carry-forward â€¢ PDF Export</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;

    // ===== Constants & utils =====
    const STATUS = { TODO:'todo', IN_PROGRESS:'in_progress', DEFERRED:'deferred', DONE:'done' };
    const STATUS_LABEL = { todo:'New', in_progress:'In Progress', deferred:'Deferred', done:'Done' };
    const LS_TASKS = 'task_manager_tasks_html_v3';

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toISODate = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fromISO = (s) => { const [y,m,d] = s.split('-').map(Number); return new Date(y,m-1,d); };
    const isSameDay = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate()+n); return r; };
    const fmtDate = (d, opts) => new Intl.DateTimeFormat('en-GB', opts || { day:'2-digit', month:'short', year:'numeric' }).format(d);
    const fmtDay = (d) => new Intl.DateTimeFormat('en-GB', { day:'numeric'}).format(d);
    const fmtMonthLabel = (d) => new Intl.DateTimeFormat('en-GB', { month:'long', year:'numeric'}).format(d);

    function loadTasks(){ try{ return JSON.parse(localStorage.getItem(LS_TASKS))||[]; }catch{return [];} }
    function saveTasks(){ localStorage.setItem(LS_TASKS, JSON.stringify(tasks)); }
    function normalizeToISODate(v){
      try {
        if (!v) return null;
        if (typeof v === 'string') return v.slice(0,10);
        if (v instanceof Date) return toISODate(v);
        if (v && typeof v.toDate === 'function') return toISODate(v.toDate());
        return null;
      } catch { return null; }
    }

    // ===== State =====
    let tasks = [];
    let selectedDate = new Date();
    let currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

    // ===== Auto-migrate: move every non-Done past task forward day-by-day until today =====
    function migrateForwardLocal(){
      const today = new Date(); today.setHours(0,0,0,0);
      for (const t of tasks){
        if (t.status===STATUS.DONE) continue;
        const iso = normalizeToISODate(t.date);
        if (!iso) continue;
        let d = fromISO(iso); d.setHours(0,0,0,0);
        while(d < today){ d = addDays(d,1); }
        t.date = toISODate(d);
      }
      saveTasks();
    }

    // ===== Calendar =====
    function startOfWeek(d){
      const r = new Date(d);
      const day = r.getDay(); // 0=Sun
      r.setDate(r.getDate()-day);
      r.setHours(0,0,0,0);
      return r;
    }
    function endOfWeek(d){ const r = startOfWeek(d); r.setDate(r.getDate()+6); return r; }

    function renderCalendar(){
      const monthLabel = document.getElementById('monthLabel');
      const grid = document.getElementById('calGrid');
      if(!monthLabel || !grid) return;

      monthLabel.textContent = fmtMonthLabel(currentMonth);
      grid.innerHTML = '';

      const start = startOfWeek(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1));
      const endMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0);
      const end = endOfWeek(endMonth);

      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const day = new Date(d);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cal-day';
        btn.setAttribute('role','gridcell');
        btn.setAttribute('aria-label', `Select ${fmtDate(day)}`);
        btn.textContent = fmtDay(day);
        if(day.getMonth() !== currentMonth.getMonth()) btn.classList.add('out');
        if(isSameDay(day, new Date())) btn.classList.add('today');
        if(isSameDay(day, selectedDate)) { btn.classList.add('selected'); btn.setAttribute('aria-pressed','true'); }
        btn.addEventListener('click', ()=>{
          selectedDate = new Date(day);
          renderCalendar();
          renderSelectedDate();
        });
        grid.appendChild(btn);
      }
    }

    // ===== Rendering =====
    function tasksFor(dateISO){ return tasks.filter(t=>t.date===dateISO); }

    function taskRow(t){
      const wrap = document.createElement('div'); wrap.className='task';
      const top = document.createElement('div'); top.className='row space-between';
      const left = document.createElement('div'); left.className='row';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = t.status===STATUS.DONE;
      cb.onchange=()=>{ t.status = cb.checked? STATUS.DONE : STATUS.TODO; saveTasks(); renderAll(); };
      const ttl = document.createElement('div'); ttl.textContent = t.title || '(No title)'; ttl.style.fontWeight='600';
      if(t.status===STATUS.DONE) ttl.classList.add('line-through');
      left.append(cb, ttl);
      top.append(left);
      wrap.append(top);
      return wrap;
    }

    function renderSelectedDate(){
      const title = document.getElementById('selDateTitle');
      const list  = document.getElementById('selectedList');
      if(!title || !list) return;
      title.textContent = `Tasks for ${fmtDate(selectedDate)}`;
      list.innerHTML = '';
      const items = tasksFor(toISODate(selectedDate));
      if(items.length===0){ list.innerHTML = '<div class="subtitle">No tasks for this date</div>'; return; }
      for(const t of items){ list.appendChild(taskRow(t)); }
    }

    function renderToday(){
      const today = new Date();
      document.getElementById('todayLabel').textContent = fmtDate(today);
      const list = document.getElementById('todayList');
      list.innerHTML = '';
      const items = tasksFor(toISODate(today));
      if(items.length===0){ list.innerHTML = '<div class="subtitle">No tasks for today</div>'; return; }
      for(const t of items){ list.appendChild(taskRow(t)); }
    }

    function renderAll(){
      renderCalendar();
      renderSelectedDate();
      renderToday();
    }

    // ===== Events =====
    // Month navigation
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id === 'prevMonth'){
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
        renderCalendar();
      }
      if(e.target && e.target.id === 'nextMonth'){
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
        renderCalendar();
      }
    });

    // Add task to selected date (prompt-based)
    document.getElementById('addTaskBtn').onclick = ()=>{
      const title = prompt('Task title');
      if(!title) return;
      tasks.push({ id: uid(), title, date: toISODate(selectedDate), status: STATUS.TODO });
      saveTasks();
      renderSelectedDate();
      renderToday();
    };

    // PDF export (simple prompts for range)
    document.getElementById('exportPdfBtn').onclick=()=>{
      const start=prompt('Start date (YYYY-MM-DD)');
      const end=prompt('End date (YYYY-MM-DD)');
      if(!start||!end) return;
      const s=fromISO(start), e=fromISO(end);
      const done=tasks.filter(t=>t.status===STATUS.DONE && new Date(t.date)>=s && new Date(t.date)<=e);
      const notDone=tasks.filter(t=>t.status!==STATUS.DONE && new Date(t.date)>=s && new Date(t.date)<=e);
      const doc=new jsPDF();
      let y=10;
      doc.setFontSize(16); doc.text('Task Report',105,y,{align:'center'}); y+=10;
      doc.setFontSize(12); doc.text('Completed:',10,y); y+=8;
      done.forEach(t=>{ doc.text(`- ${t.title} (${t.date})`,15,y); y+=8; });
      y+=6; doc.text('Not Completed:',10,y); y+=8;
      notDone.forEach(t=>{ doc.text(`- ${t.title} (${t.date})`,15,y); y+=8; });
      doc.save('tasks-report.pdf');
    };

    // ===== Init =====
    function init(){
      tasks = loadTasks();
      migrateForwardLocal(); // always carry-forward older incomplete tasks up to today
      selectedDate = new Date();
      currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
      renderAll();
    }
    init();
  </script>
</body>
</html>
