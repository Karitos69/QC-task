<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager â€“ HTML (Firestore + Auto-migrate + PDF)</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--text:#111;--muted:#6b7280;--border:#e5e7eb;--accent:#111}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .section{padding:18px}
    .title{margin:0 0 8px;font-weight:700}
    .subtitle{margin:0 0 16px;color:var(--muted);font-size:.95rem}
    .row{display:flex;align-items:center;gap:8px}
    .space-between{justify-content:space-between}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#f3f4f6}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .list{display:flex;flex-direction:column;gap:10px}
    .task{border:1px solid var(--border);border-radius:14px;padding:10px}
    .task .muted{color:var(--muted);font-size:.9rem}
    .task .line-through{text-decoration:line-through;color:#9ca3af}
    .calendar{padding:14px}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-day{aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .cal-day.out{opacity:.35}
    .cal-day.today{border-color:#111}
    .cal-day.selected{background:#111;color:#fff;border-color:#111}
    .cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:6px}
    .footer{margin-top:22px;text-align:center;color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="grid">
      <!-- Calendar -->
      <div>
        <div class="card calendar">
          <div class="cal-head">
            <div class="row" id="monthLabel" style="font-weight:600"></div>
            <div class="row">
              <button class="btn" id="prevMonth" aria-label="Previous month">â—€</button>
              <button class="btn" id="nextMonth" aria-label="Next month">â–¶</button>
            </div>
          </div>
          <div class="cal-weekdays" aria-hidden="true">
            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
          </div>
          <div id="calGrid" class="cal-grid" role="grid" aria-label="Calendar"></div>
        </div>

        <div class="card section" style="margin-top:12px">
          <div class="row space-between">
            <h3 class="title" id="selDateTitle"></h3>
            <button id="addTaskBtn" class="btn primary">ï¼‹ Add Task</button>
          </div>
          <div id="selectedList" class="list"></div>
        </div>
      </div>

      <!-- Main -->
      <div class="grid" style="grid-template-columns:1fr">
        <div class="card section">
          <h2 class="title">Today â€“ <span id="todayLabel"></span></h2>
          <p class="subtitle">Tasks to complete</p>
          <div id="todayList" class="list"></div>
          <button class="btn primary" id="exportPdfBtn" style="margin-top:10px">ðŸ“„ Export PDF</button>
        </div>
      </div>
    </div>

    <div class="footer">HTML Task Manager â€¢ Firestore + Local fallback â€¢ Auto carry-forward â€¢ PDF Export</div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <script>
    // ===== App (UI + local fallback) =====
    const { jsPDF } = window.jspdf;
    const STATUS = { TODO:'todo', IN_PROGRESS:'in_progress', DEFERRED:'deferred', DONE:'done' };
    const LS_TASKS = 'task_manager_tasks_html_fs_v1';

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toISODate = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fromISO = (s) => { const [y,m,d] = s.split('-').map(Number); return new Date(y,m-1,d); };
    const isSameDay = (a,b) => a.toDateString()===b.toDateString();
    const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate()+n); return r; };
    const fmtDate = (d, opts) => new Intl.DateTimeFormat('en-GB', opts || { day:'2-digit', month:'short', year:'numeric' }).format(d);
    const fmtDay = (d) => new Intl.DateTimeFormat('en-GB', { day:'numeric'}).format(d);
    const fmtMonthLabel = (d) => new Intl.DateTimeFormat('en-GB', { month:'long', year:'numeric'}).format(d);

    function loadTasks(){ try{ return JSON.parse(localStorage.getItem(LS_TASKS))||[]; }catch{return [];} }
    function saveTasks(){ localStorage.setItem(LS_TASKS, JSON.stringify(tasks)); }

    function normalizeToISODate(v){
      try{
        if(!v) return null;
        if(typeof v==='string') return v.slice(0,10);
        if(v instanceof Date) return toISODate(v);
        if(v && typeof v.toDate==='function') return toISODate(v.toDate()); // Firestore Timestamp
        return null;
      }catch{return null;}
    }

    // App state
    let tasks = [];            // local cache (used also with cloud)
    let selectedDate = new Date();
    let currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

    // Auto-carry forward (local cache) â€“ moves every non-Done past task forward day-by-day until today
    function migrateForwardLocal(){
      const today = new Date(); today.setHours(0,0,0,0);
      let changed = false;
      for(const t of tasks){
        if(t.status==='done' || t.status=== 'DONE') continue;
        const iso = normalizeToISODate(t.date);
        if(!iso) continue;
        let d = fromISO(iso); d.setHours(0,0,0,0);
        while(d < today){ d = addDays(d,1); }
        const newISO = toISODate(d);
        if(newISO !== iso){ t.date = newISO; changed = true; }
      }
      if(changed) saveTasks();
    }

    // Calendar
    function startOfWeek(d){ const r=new Date(d); const day=r.getDay(); r.setDate(r.getDate()-day); r.setHours(0,0,0,0); return r; }
    function endOfWeek(d){ const r=startOfWeek(d); r.setDate(r.getDate()+6); return r; }

    function renderCalendar(){
      document.getElementById('monthLabel').textContent = fmtMonthLabel(currentMonth);
      const grid = document.getElementById('calGrid'); grid.innerHTML='';
      const start = startOfWeek(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1));
      const endMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0);
      const end = endOfWeek(endMonth);
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const day = new Date(d);
        const btn = document.createElement('button'); btn.type='button'; btn.className='cal-day'; btn.textContent = fmtDay(day);
        if(day.getMonth()!==currentMonth.getMonth()) btn.classList.add('out');
        if(isSameDay(day,new Date())) btn.classList.add('today');
        if(isSameDay(day,selectedDate)) btn.classList.add('selected');
        btn.addEventListener('click', ()=>{
          selectedDate = new Date(day);
          renderCalendar();
          renderSelected();
          // refresh cloud listener to selected date
          if(window.cloudOnSelectDate) window.cloudOnSelectDate(toISODate(selectedDate));
        });
        grid.appendChild(btn);
      }
    }

    function tasksFor(dateISO){ return tasks.filter(t=> normalizeToISODate(t.date) === dateISO); }

    function taskRow(t){
      const wrap = document.createElement('div'); wrap.className='task';
      const top = document.createElement('div'); top.className='row space-between';
      const left = document.createElement('div'); left.className='row';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = (t.status==='done' || t.status==='DONE');
      cb.onchange = async ()=>{
        const newStatus = cb.checked ? 'done' : 'todo';
        if(window.cloudUpdateTask){ try{ await window.cloudUpdateTask(t.id, { status: newStatus }); } catch(e){ console.warn(e);} }
        t.status = newStatus; saveTasks(); renderAll();
      };
      const ttl = document.createElement('div'); ttl.textContent = t.title || '(No title)'; ttl.style.fontWeight='600';
      if(cb.checked) ttl.classList.add('line-through');
      left.append(cb, ttl);
      const del = document.createElement('button'); del.className='btn'; del.textContent='Delete';
      del.onclick = async ()=>{
        if(window.cloudDeleteTask){ try{ await window.cloudDeleteTask(t.id); } catch(e){ console.warn(e); } }
        tasks = tasks.filter(x=>x.id!==t.id); saveTasks(); renderAll();
      };
      top.append(left, del);
      wrap.append(top);
      return wrap;
    }

    function renderSelected(){
      const selISO = toISODate(selectedDate);
      document.getElementById('selDateTitle').textContent = `Tasks for ${fmtDate(selectedDate)}`;
      const list = document.getElementById('selectedList'); list.innerHTML = '';
      const items = tasksFor(selISO);
      if(items.length===0){ list.innerHTML = '<div class="subtitle">No tasks</div>'; return; }
      for(const t of items){ list.appendChild(taskRow(t)); }
    }

    function renderToday(){
      document.getElementById('todayLabel').textContent = fmtDate(new Date());
      const list = document.getElementById('todayList'); list.innerHTML = '';
      const items = tasksFor(toISODate(new Date()));
      if(items.length===0){ list.innerHTML = '<div class="subtitle">No tasks for today</div>'; return; }
      for(const t of items){ list.appendChild(taskRow(t)); }
    }

    function renderAll(){ renderCalendar(); renderSelected(); renderToday(); }

    // UI events
    document.getElementById('prevMonth').onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendar(); };
    document.getElementById('nextMonth').onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendar(); };

    document.getElementById('addTaskBtn').onclick = async ()=>{
      const title = prompt('Task title?');
      if(!title) return;
      const newTask = { id: uid(), title, date: toISODate(selectedDate), status: 'todo' };
      // cloud first
      if(window.cloudAddTask){
        try{ await window.cloudAddTask(newTask); } catch(e){ console.warn(e); tasks.push(newTask); saveTasks(); }
      } else {
        tasks.push(newTask); saveTasks();
      }
      renderAll();
    };

    document.getElementById('exportPdfBtn').onclick = async ()=>{
      const from = prompt('From (YYYY-MM-DD)');
      const to   = prompt('To (YYYY-MM-DD)');
      if(!from || !to) return;
      if(from > to){ alert('Invalid range'); return; }
      let items = [];
      if(window.cloudFetchRange){
        try{ items = await window.cloudFetchRange(from, to); }
        catch(e){ console.warn(e); items = tasks; }
      } else {
        items = tasks;
      }
      items = items
        .map(t=> ({...t, date: normalizeToISODate(t.date)}))
        .filter(t=> t.date && t.date>=from && t.date<=to);
      exportTasksToPdf(items, from, to);
    };

    function exportTasksToPdf(items, from, to){
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const marginX = 40; let y=48;
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text(`Tasks Report ${from} â€“ ${to}`, marginX, y); y+=20;

      const done = items.filter(t=> (t.status==='done'||t.status==='DONE'));
      const notDone = items.filter(t=> !(t.status==='done'||t.status==='DONE'));

      const section = (title, arr)=>{
        y+=10; doc.setFont('helvetica','bold'); doc.text(title, marginX, y); y+=12;
        doc.setFont('helvetica','normal'); doc.setFontSize(12);
        if(arr.length===0){ doc.text('â€” None â€”', marginX, y); y+=16; return; }
        for(const t of arr){
          const line = `â€¢ ${t.title || '(No title)'} â€” Date: ${t.date || 'â€”'} â€” Status: ${t.status}`;
          const parts = doc.splitTextToSize(line, 515);
          if(y + parts.length*14 > 800){ doc.addPage(); y=48; }
          doc.text(parts, marginX, y); y += parts.length*14 + 6;
        }
      };
      section('Section 1: Completed within range', done);
      section('Section 2: Not completed within range', notDone);
      doc.save(`tasks_report_${from}_to_${to}.pdf`);
    }

    // Init (local first; cloud will override)
    function init(){
      tasks = loadTasks();
      migrateForwardLocal();
      renderAll();
    }
    init();
  </script>

  <!-- ===== Firebase / Firestore (module) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === Your project config (same as before) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDLVGDemdsjcCUjeGQwUA06NdDu5QGr9QI",
      authDomain: "qc-task.firebaseapp.com",
      projectId: "qc-task",
      storageBucket: "qc-task.firebasestorage.app",
      messagingSenderId: "811038001243",
      appId: "1:811038001243:web:17093b369a0b12389ad77e",
      measurementId: "G-V7WG3M18B1"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    function ensureAuth() {
      return new Promise((resolve, reject) => {
        onAuthStateChanged(auth, async (user) => {
          try{
            if (user) return resolve(user);
            await signInAnonymously(auth);
          }catch(e){ reject(e); }
        });
      });
    }

    // ---- Cloud API exposed to the UI (window.*) ----
    window.cloudAddTask = async (task) => {
      const id = task.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
      await setDoc(doc(tasksCol, id), { ...task, id });
      return id;
    };
    window.cloudUpdateTask = async (id, patch) => updateDoc(doc(tasksCol, id), patch);
    window.cloudDeleteTask = async (id) => deleteDoc(doc(tasksCol, id));

    // Move all non-done past tasks to today (end state = today)
    window.cloudMigrateForward = async () => {
      const todayISO = new Date().toISOString().slice(0,10);
      const snap = await getDocs(tasksCol);
      const updates = [];
      snap.forEach(dref => {
        const t = dref.data();
        const status = (t.status||'').toLowerCase();
        if (status === 'done') return;
        const iso = (typeof t.date === 'string') ? t.date.slice(0,10)
                  : (t.date && typeof t.date.toDate==='function') ? toISODate(t.date.toDate())
                  : null;
        if (!iso) return;
        if (iso < todayISO) updates.push(updateDoc(doc(tasksCol, t.id), { date: todayISO }));
      });
      await Promise.all(updates);
    };

    // Range fetch for PDF
    window.cloudFetchRange = async (fromISO, toISO) => {
      const q1 = query(tasksCol, where("date", ">=", fromISO), where("date", "<=", toISO));
      const snap = await getDocs(q1);
      const items = [];
      snap.forEach(d => items.push(d.data()));
      items.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
      return items;
    };

    // Live listeners: selected date & today
    let _unsubSelected = null;
    let _unsubToday    = null;

    function applyItemsForDate(dateISO, items){
      // merge cloud items into local cache for that date, replace same-date items
      tasks = tasks.filter(t => (normalizeToISODate(t.date)!==dateISO)).concat(items);
      localStorage.setItem(LS_TASKS, JSON.stringify(tasks));
    }

    window.cloudOnSelectDate = (dateISO) => {
      if (_unsubSelected) _unsubSelected();
      const qSel = query(tasksCol, where("date","==", dateISO));
      _unsubSelected = onSnapshot(qSel, (snap)=>{
        const items = snap.docs.map(d=>d.data());
        applyItemsForDate(dateISO, items);
        // if this is today as well â€“ re-render both
        if (dateISO === new Date().toISOString().slice(0,10)) {
          renderToday();
        }
        renderSelected();
      });
    };

    function subscribeToday(){
      const todayISO = new Date().toISOString().slice(0,10);
      if (_unsubToday) _unsubToday();
      const qToday = query(tasksCol, where("date","==", todayISO));
      _unsubToday = onSnapshot(qToday, (snap)=>{
        const items = snap.docs.map(d=>d.data());
        applyItemsForDate(todayISO, items);
        renderToday();
      });
      // also ensure selected date has a listener
      window.cloudOnSelectDate(toISODate(selectedDate));
    }

    // Boot cloud
    (async ()=>{
      try{
        await ensureAuth();
        await window.cloudMigrateForward();
        subscribeToday(); // start live listeners (today + selected)
      }catch(e){
        console.warn('Cloud not available, local-only mode:', e);
      }
    })();
  </script>
</body>
</html>
